<main>
  <h2 class="text-xl font-bold mb-4"><span class="font-paragon">News Editor</span></h2>

  <% if (typeof messages !== 'undefined' && (messages.success.length || messages.error.length)) { %>
    <div>
      <% messages.success.forEach(msg => { %>
        <p class="text-green-500"><%= msg %></p>
      <% }) %>
      <% messages.error.forEach(msg => { %>
        <p class="text-red-500"><%= msg %></p>
      <% }) %>
    </div>
  <% } %>

  <form id="news-form" method="POST" action="/admin/news/save" class="space-y-4">
    <input type="hidden" name="id" id="news-id" value="<%= post?.id || '' %>">

    <!-- Title -->
    <div>
      <label for="news-title" class="block mb-1 font-paragon">Title:</label>
      <input
        type="text"
        id="news-title"
        name="title"
        value="<%= post?.title || '' %>"
        class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
      >
    </div>

    <!-- Pinned -->
    <div class="flex items-center space-x-2">
      <input
        type="checkbox"
        id="news-pinned"
        name="pinned"
        <%= post?.pinned ? 'checked' : '' %>
        class="h-4 w-4 text-blue-600 border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600"
      >
      <label for="news-pinned" class="font-paragon">Pinned</label>
    </div>

    <!-- Content -->
    <div>
      <label for="editor" class="block mb-1 font-paragon">Content:</label>
      <div
        id="editor"
        class="bg-white dark:bg-gray-800 text-black dark:text-white p-3 rounded border border-gray-300 dark:border-gray-600"
        style="min-height: 150px;"
      ></div>
      <input type="hidden" name="content" id="news-content" value="<%- post?.content || '' %>">
    </div>

    <!-- Submit Button -->
    <div class="pt-2">
      <button
        type="submit"
        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition"
      >
        <span class="font-paragon">Save</span>
      </button>
    </div>
  </form>

  <h3 class="text-lg font-semibold mt-6">
    <span class="font-paragon">All News Posts</span>
  </h3>

  <ul id="news-list" class="mt-2 space-y-2">
    <% news.forEach(item => { %>
      <li class="bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 p-3 rounded flex justify-between items-center border border-gray-300 dark:border-gray-700" data-id="<%= item.id %>">
        <span>
          <strong class="font-medium"><%= item.title %></strong> â€”
          <em class="post-date text-gray-600 dark:text-gray-400" data-utc="<%= item.date %>"></em>
          <% if (item.pinned) { %>
            <span class="text-yellow-600 dark:text-yellow-400 ml-2">(Pinned)</span>
          <% } %>
        </span>
        <span class="flex items-center space-x-3">
          <button data-edit='<%- JSON.stringify(item) %>' class="edit-btn text-sm text-blue-600 dark:text-blue-400 hover:underline">Edit</button>
          <form action="/admin/news/delete" method="POST" class="inline">
            <input type="hidden" name="id" value="<%= item.id %>">
            <button class="text-sm text-red-600 dark:text-red-400 hover:underline">Delete</button>
          </form>
        </span>
      </li>
    <% }) %>
  </ul>

  <form id="reorder-form" method="POST" action="/admin/news/reorder">
    <input type="hidden" name="order" id="news-order">
  </form>
</main>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<script>
  const editor = new Quill('#editor', { theme: 'snow' });
  const contentInput = document.getElementById('news-content');

  // Load content if editing
  if (contentInput.value) {
    try {
      editor.root.innerHTML = contentInput.value;
    } catch (e) {}
  }

  document.getElementById('news-form').addEventListener('submit', () => {
    contentInput.value = editor.root.innerHTML;
  });

  // Edit support
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const post = JSON.parse(btn.getAttribute('data-edit'));
      document.getElementById('news-id').value = post.id;
      document.getElementById('news-title').value = post.title;
      editor.root.innerHTML = post.content || '';
      document.getElementById('news-pinned').checked = !!post.pinned;
    });
  });

  document.querySelectorAll('.post-date').forEach(el => {
    const utc = el.getAttribute('data-utc');
    if (utc) {
      const local = new Date(utc).toLocaleString(undefined, {
        dateStyle: 'medium',
        timeStyle: 'short'
      });
      el.textContent = local;
    }
  });
</script>
